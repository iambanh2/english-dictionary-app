class SignInApp {
    constructor() {
        this.initializeElements();
        this.bindEvents();
        this.checkAuthState();
        
        console.log('üîê Sign In App loaded');
    }

    initializeElements() {
        this.form = document.getElementById('signinForm');
        this.emailInput = document.getElementById('email');
        this.passwordInput = document.getElementById('password');
        this.rememberMeCheckbox = document.getElementById('rememberMe');
        this.signinBtn = document.getElementById('signinBtn');
        this.googleSigninBtn = document.getElementById('googleSigninBtn');
        this.forgotPasswordLink = document.getElementById('forgotPasswordLink');
        this.errorMessage = document.getElementById('errorMessage');
        this.successMessage = document.getElementById('successMessage');
        this.loadingSpinner = document.getElementById('loadingSpinner');
    }

    bindEvents() {
        this.form.addEventListener('submit', (e) => this.handleSignIn(e));
        this.googleSigninBtn.addEventListener('click', () => this.handleGoogleSignIn());
        this.forgotPasswordLink.addEventListener('click', (e) => this.handleForgotPassword(e));
        
        // Load remembered email
        this.loadRememberedEmail();
    }

    loadRememberedEmail() {
        const rememberedEmail = localStorage.getItem('rememberedEmail');
        if (rememberedEmail) {
            this.emailInput.value = rememberedEmail;
            this.rememberMeCheckbox.checked = true;
        }
    }

    async checkAuthState() {
        // Wait for Firebase to initialize
        let attempts = 0;
        while (!window.firebase && attempts < 50) {
            await new Promise(resolve => setTimeout(resolve, 100));
            attempts++;
        }

        if (window.firebase && window.firebase.auth) {
            const { onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js');
            
            onAuthStateChanged(window.firebase.auth, (user) => {
                if (user) {
                    console.log('User already logged in, redirecting...');
                    this.showMessage('success', '‚úÖ B·∫°n ƒë√£ ƒëƒÉng nh·∫≠p! ƒêang chuy·ªÉn h∆∞·ªõng...');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                }
            });
        }
    }

    async handleSignIn(e) {
        e.preventDefault();
        
        const email = this.emailInput.value.trim();
        const password = this.passwordInput.value;

        // Validation
        if (!this.validateForm(email, password)) {
            return;
        }

        this.setLoading(true);

        try {
            const { signInWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js');
            const { doc, updateDoc, getDoc } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js');

            // Sign in user
            const userCredential = await signInWithEmailAndPassword(window.firebase.auth, email, password);
            const user = userCredential.user;

            // Remember email if checkbox is checked
            if (this.rememberMeCheckbox.checked) {
                localStorage.setItem('rememberedEmail', email);
            } else {
                localStorage.removeItem('rememberedEmail');
            }

            // Update last login time in Firestore
            try {
                const userDocRef = doc(window.firebase.db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    await updateDoc(userDocRef, {
                        lastLogin: new Date().toISOString()
                    });
                } else {
                    // Create user document if it doesn't exist (for legacy users)
                    await setDoc(userDocRef, {
                        displayName: user.displayName || 'User',
                        email: user.email,
                        createdAt: new Date().toISOString(),
                        savedWords: {},
                        totalWords: 0,
                        lastLogin: new Date().toISOString()
                    });
                }
            } catch (firestoreError) {
                console.warn('Could not update user document:', firestoreError);
                // Don't fail the login for this
            }

            console.log('‚úÖ User signed in successfully:', user.uid);
            
            this.showMessage('success', `üéâ ƒêƒÉng nh·∫≠p th√†nh c√¥ng! Xin ch√†o ${user.displayName || user.email}!`);
            
            // Redirect after 2 seconds
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);

        } catch (error) {
            console.error('Sign in error:', error);
            this.handleSignInError(error);
        } finally {
            this.setLoading(false);
        }
    }

    async handleGoogleSignIn() {
        this.setLoading(true);
        
        try {
            const { GoogleAuthProvider, signInWithPopup } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js');
            const { doc, setDoc, getDoc, updateDoc } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js');

            const provider = new GoogleAuthProvider();
            
            // Add additional scopes if needed
            provider.addScope('email');
            provider.addScope('profile');
            
            // Set custom parameters for better UX
            provider.setCustomParameters({
                prompt: 'select_account' // Always show account selection
            });

            console.log('üåê Initiating Google Sign-In...');
            const result = await signInWithPopup(window.firebase.auth, provider);
            const user = result.user;

            console.log('üåê Google Sign-In successful:', {
                uid: user.uid,
                displayName: user.displayName,
                email: user.email,
                photoURL: user.photoURL,
                emailVerified: user.emailVerified,
                providerData: user.providerData
            });

            // Create or update user document in Firestore
            const userDocRef = doc(window.firebase.db, 'users', user.uid);
            const userDoc = await getDoc(userDocRef);
            
            if (!userDoc.exists()) {
                // Create new user document
                await setDoc(userDocRef, {
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    createdAt: new Date().toISOString(),
                    savedWords: {},
                    totalWords: 0,
                    lastLogin: new Date().toISOString(),
                    provider: 'google',
                    emailVerified: user.emailVerified
                });
                console.log('üìù Created new Google user document');
            } else {
                // Update existing user document
                await updateDoc(userDocRef, {
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    lastLogin: new Date().toISOString(),
                    emailVerified: user.emailVerified
                });
                console.log('üìù Updated existing Google user document');
            }

            this.showMessage('success', `üéâ ƒêƒÉng nh·∫≠p Google th√†nh c√¥ng! Xin ch√†o ${user.displayName}!`);
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);

        } catch (error) {
            console.error('Google sign in error:', error);
            
            let message = '‚ùå L·ªói ƒëƒÉng nh·∫≠p Google';
            
            switch (error.code) {
                case 'auth/popup-closed-by-user':
                    message = '‚ùå ƒêƒÉng nh·∫≠p b·ªã h·ªßy b·ªüi ng∆∞·ªùi d√πng';
                    break;
                case 'auth/popup-blocked':
                    message = '‚ùå Popup b·ªã ch·∫∑n. Vui l√≤ng cho ph√©p popup v√† th·ª≠ l·∫°i.';
                    break;
                case 'auth/cancelled-popup-request':
                    message = '‚ùå Y√™u c·∫ßu ƒëƒÉng nh·∫≠p b·ªã h·ªßy';
                    break;
                case 'auth/operation-not-allowed':
                    message = '‚ùå Google Sign-In ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t. Vui l√≤ng k√≠ch ho·∫°t trong Firebase Console.';
                    break;
                case 'auth/invalid-api-key':
                    message = '‚ùå API key kh√¥ng h·ª£p l·ªá';
                    break;
                case 'auth/network-request-failed':
                    message = '‚ùå L·ªói k·∫øt n·ªëi m·∫°ng. Vui l√≤ng th·ª≠ l·∫°i.';
                    break;
                case 'auth/too-many-requests':
                    message = '‚ùå Qu√° nhi·ªÅu y√™u c·∫ßu. Vui l√≤ng th·ª≠ l·∫°i sau.';
                    break;
                default:
                    message = `‚ùå L·ªói ƒëƒÉng nh·∫≠p Google: ${error.message}`;
            }
            
            this.showMessage('error', message);
        } finally {
            this.setLoading(false);
        }
    }

    async handleForgotPassword(e) {
        e.preventDefault();
        
        const email = this.emailInput.value.trim();
        if (!email) {
            this.showMessage('error', '‚ùå Vui l√≤ng nh·∫≠p email tr∆∞·ªõc khi reset m·∫≠t kh·∫©u');
            return;
        }

        try {
            const { sendPasswordResetEmail } = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js');
            
            await sendPasswordResetEmail(window.firebase.auth, email);
            
            this.showMessage('success', `üìß Email reset m·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn ${email}. Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞!`);
            
        } catch (error) {
            console.error('Password reset error:', error);
            
            if (error.code === 'auth/user-not-found') {
                this.showMessage('error', '‚ùå Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n v·ªõi email n√†y');
            } else if (error.code === 'auth/invalid-email') {
                this.showMessage('error', '‚ùå Email kh√¥ng h·ª£p l·ªá');
            } else {
                this.showMessage('error', `‚ùå L·ªói reset m·∫≠t kh·∫©u: ${error.message}`);
            }
        }
    }

    validateForm(email, password) {
        if (!email) {
            this.showMessage('error', '‚ùå Vui l√≤ng nh·∫≠p email');
            return false;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            this.showMessage('error', '‚ùå Email kh√¥ng h·ª£p l·ªá');
            return false;
        }

        if (!password) {
            this.showMessage('error', '‚ùå Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u');
            return false;
        }

        return true;
    }

    handleSignInError(error) {
        let message = 'C√≥ l·ªói x·∫£y ra khi ƒëƒÉng nh·∫≠p';
        
        switch (error.code) {
            case 'auth/user-not-found':
                message = '‚ùå Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n v·ªõi email n√†y. Vui l√≤ng ki·ªÉm tra l·∫°i ho·∫∑c ƒëƒÉng k√Ω t√†i kho·∫£n m·ªõi.';
                break;
            case 'auth/wrong-password':
                message = '‚ùå M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c reset m·∫≠t kh·∫©u.';
                break;
            case 'auth/invalid-email':
                message = '‚ùå ƒê·ªãa ch·ªâ email kh√¥ng h·ª£p l·ªá';
                break;
            case 'auth/user-disabled':
                message = '‚ùå T√†i kho·∫£n n√†y ƒë√£ b·ªã v√¥ hi·ªáu h√≥a';
                break;
            case 'auth/too-many-requests':
                message = '‚ùå Qu√° nhi·ªÅu l·∫ßn th·ª≠ ƒëƒÉng nh·∫≠p. Vui l√≤ng th·ª≠ l·∫°i sau v√†i ph√∫t.';
                break;
            case 'auth/network-request-failed':
                message = '‚ùå L·ªói k·∫øt n·ªëi m·∫°ng. Vui l√≤ng ki·ªÉm tra internet v√† th·ª≠ l·∫°i.';
                break;
            case 'auth/operation-not-allowed':
                message = '‚ùå ƒêƒÉng nh·∫≠p email/m·∫≠t kh·∫©u ch∆∞a ƒë∆∞·ª£c k√≠ch ho·∫°t. Vui l√≤ng li√™n h·ªá admin.';
                break;
            case 'auth/invalid-credential':
                message = '‚ùå Th√¥ng tin ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra email v√† m·∫≠t kh·∫©u.';
                break;
            default:
                message = `‚ùå L·ªói: ${error.message}`;
                console.error('Sign in error details:', error);
        }
        
        this.showMessage('error', message);
    }

    showMessage(type, message) {
        this.hideMessages();
        
        if (type === 'error') {
            this.errorMessage.textContent = message;
            this.errorMessage.style.display = 'block';
        } else if (type === 'success') {
            this.successMessage.textContent = message;
            this.successMessage.style.display = 'block';
        }
    }

    hideMessages() {
        this.errorMessage.style.display = 'none';
        this.successMessage.style.display = 'none';
    }

    setLoading(loading) {
        if (loading) {
            this.loadingSpinner.style.display = 'block';
            this.signinBtn.disabled = true;
            this.googleSigninBtn.disabled = true;
        } else {
            this.loadingSpinner.style.display = 'none';
            this.signinBtn.disabled = false;
            this.googleSigninBtn.disabled = false;
        }
    }
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new SignInApp();
});
